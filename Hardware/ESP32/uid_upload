#include <WiFi.h>
#include <HTTPClient.h>

// Wi‑Fi credentials
const char* ssid     = "xyz";
const char* password = "abcd";

// Your attendance API endpoint (e.g. "http://192.168.1.25:3000/api/attendance")
const char* serverUrl = "https://employee-access-control-anirudhs-projects-22c040b8.vercel.app/api/attendance";

// UART2 pins on ESP32
static const int STM32_RX_PIN = 16;  // connect STM32 TX → this pin
static const int STM32_TX_PIN = 17;  // connect STM32 RX → this pin (not used here)

HardwareSerial STMserial(2); // Use UART2

void setup() {
  // 1. USB‑Serial console
  Serial.begin(115200);
  while (!Serial) { delay(10); }
  Serial.println("\n=== ESP32 Attendance Client ===");

  // 2. UART2 for STM32 → ESP32
  STMserial.begin(115200, SERIAL_8N1, STM32_RX_PIN, STM32_TX_PIN);

  // 3. Connect to Wi‑Fi
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print('.');
  }
  Serial.println("\nWiFi connected, IP: " + WiFi.localIP().toString());
}

void loop() {
  // 4. Read a line (up to '\n') from STM32
  if (STMserial.available()) {
    String uid = STMserial.readStringUntil('\n');
    uid.trim();  // remove \r and whitespace

    if (uid.length() > 0) {
      Serial.println("Read UID: " + uid);
      postUID(uid);
    }
  }

  delay(10); // yield
}

void postUID(const String& uid) {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("WiFi lost, reconnecting...");
    WiFi.reconnect();
    return;
  }

  HTTPClient http;
  http.begin(serverUrl);
  http.addHeader("Content-Type", "application/json");

  // Build JSON payload
  String body = "{\"uid\":\"" + uid + "\"}";

  int httpCode = http.POST(body);
  if (httpCode > 0) {
    Serial.printf("POST %s → %d\n", serverUrl, httpCode);
    if (httpCode == HTTP_CODE_OK) {
      Serial.println("Attendance recorded");
    } else {
      Serial.println("Server error");
    }
  } else {
    Serial.println("HTTP POST failed: " + http.errorToString(httpCode));
  }

  http.end();
}
